!function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.loaded=!1,this.app=e,this.resources=[]}load(e){this.app.loader.add(this.resources.filter(e=>{if(!this.app.loader.resources[e])return e})),this.app.loader.load(t=>{this.show(t.resources),e&&e()})}show(e){}hide(){}}},function(e,t,s){const{DancingStormtrooper:i}=s(2),{ShatteringEngel:o}=s(3),{Overlay:r}=s(4),{DemoThumb:a}=s(5),{PinkCube:n}=s(8),{WalrusCave:l}=s(9);PIXI.settings.GC_MODE=PIXI.GC_MODES.MANUAL;let h=new PIXI.Application({backgroundColor:16711680,antialias:!0,view:document.getElementById("demo-canvas"),resizeTo:window,resolution:Math.min(2,window.devicePixelRatio),autoDensity:!0}),c=new r("ui-overlay"),u=new r("load-overlay"),m=e=>{document.body.classList.remove("disable-scrolling"),c.hide(()=>{document.getElementById("demo-canvas").classList.remove("show"),e.hide()})},d=e=>{document.body.classList.add("disable-scrolling"),document.onkeypress=t=>{"Escape"===t.key&&m(e)},document.getElementById("ui-close").onclick=()=>{m(e)},u.show(()=>{e.load(()=>{document.getElementById("demo-canvas").classList.add("show"),c.show(()=>{u.hide()})})})};new a("dancing-stormtrooper",new i(h),"<a href='https://sketchfab.com/3d-models/dancing-stormtrooper-12bd08d66fe04a84be446e583d6663ac'>Model created by StrykerDoesAnimation.</a> License: <a href='https://creativecommons.org/licenses/by/4.0/'>CC Attribution</a>.",d),new a("pink-cube",new n(h),"",d),new a("walrus-cave",new l(h),"Art from <a href='https://sketchfab.com/3d-models/walrus-cave-691f94c653b242f1a172ba018b4e6318'>rosiejarvis</a>,  <a href='https://sketchfab.com/3d-models/l-p-shark-cage-diving-scene-5bf4fcbbc6ea40b69c734f54180fa38c'>EdwinRC</a>, <a href='https://sketchfab.com/3d-models/sea-keep-lonely-watcher-09a15a0c14cb4accaf060a92bc70413d'>Artjoms Horosilovs</a> and <a href='https://sketchfab.com/3d-models/stylized-crate-537ae14262ad4327b2f9405d27a37b3b'>Berty56</a>. License: <a href='https://creativecommons.org/licenses/by/4.0/'>CC Attribution</a>.",d),new a("shattering-engel",new o(h),"<a href='https://sketchfab.com/3d-models/engel-c958d74ae18c4734b37dbc3ff0841f8a'>Model created by noe-3d.at.</a> License: <a href='https://creativecommons.org/licenses/by/4.0/'>CC Attribution</a>.",d)},function(e,t,s){"use strict";s.r(t),s.d(t,"DancingStormtrooper",(function(){return o}));var i=s(0);class o extends i.a{constructor(e){super(e),this.resources=["models/dancing_stormtrooper/scene.gltf","environments/photo_studio/diffuse.cubemap","environments/photo_studio/specular.cubemap"]}show(e){this.app.renderer.backgroundColor=39219,this.dirLight=Object.assign(new PIXI3D.Light,{type:"directional",intensity:1.5,x:0,y:0,z:5}),this.dirLight.rotationQuaternion.setEulerAngles(10,180,0);let t=new PIXI3D.ImageBasedLighting(e["environments/photo_studio/diffuse.cubemap"].cubemap,e["environments/photo_studio/specular.cubemap"].cubemap);this.lightingEnvironment=new PIXI3D.LightingEnvironment(this.app.renderer,t),this.lightingEnvironment.lights.push(this.dirLight),this.camera=new PIXI3D.Camera(this.app.renderer),this.camera.rotationQuaternion.setEulerAngles(-10,180,0),this.ticker=new PIXI.Ticker,this.ticker.add(()=>{let e=this.app.renderer.width/this.app.renderer.height;this.camera.fieldOfView=e>.8?60:77}),this.ticker.start(),this.container=this.app.stage.addChild(new PIXI3D.Container3D),this.model=this.container.addChild(PIXI3D.Model.from(e["models/dancing_stormtrooper/scene.gltf"].gltf)),this.model.scale.set(2.3),this.model.y=-5.2,this.model.rotationQuaternion.setEulerAngles(0,0,0),this.model.meshes.forEach(e=>{e.material.camera=this.camera,e.material.lightingEnvironment=this.lightingEnvironment,e.material.exposure=1.1}),this.model.animations[0].loop=!0,this.model.animations[0].play(),this.shadowCastingLight=new PIXI3D.ShadowCastingLight(this.app.renderer,this.dirLight,{shadowTextureSize:1024,quality:PIXI3D.ShadowQuality.medium}),this.shadowCastingLight.softness=1,this.shadowCastingLight.shadowArea=25,this.app.renderer.plugins.pipeline.enableShadows(this.model,this.shadowCastingLight)}hide(){let e=this.app.renderer.plugins.pipeline;this.shadowCastingLight.destroy(),this.model.meshes.forEach(e=>{e.destroy()}),this.ticker.stop(),e.shadowPass.removeShadowCastingLight(this.shadowCastingLight),this.app.stage.removeChildren()}}},function(e,t,s){"use strict";s.r(t),s.d(t,"ShatteringEngel",(function(){return o}));var i=s(0);class o extends i.a{constructor(e){super(e),this.resources=["models/engel/engel1.gltf","models/engel/engel2.gltf"]}show(e){document.getElementById("ui-content").innerHTML="<i class='far fa-hand-pointer fa-6x hand-pointer'></i>",this.app.renderer.backgroundColor=8895433,this.spotLight=Object.assign(new PIXI3D.Light,{type:"spot",intensity:100,x:0,y:2,z:5,color:new PIXI3D.Color(1,1,1),range:30}),this.spotLight.rotationQuaternion.setEulerAngles(0,180,0),this.lightingEnvironment=new PIXI3D.LightingEnvironment(this.app.renderer),this.lightingEnvironment.lights.push(this.spotLight),this.camera=new PIXI3D.Camera(this.app.renderer),this.camera.rotationQuaternion.setEulerAngles(-10,180,0),this.container=this.app.stage.addChild(new PIXI3D.Container3D),this.container.y=-3.3,this.container.scale.set(.85),this.model1=this.container.addChild(PIXI3D.Model.from(e["models/engel/engel1.gltf"].gltf)),this.model1.visible=!0,this.model1.interactive=!0,this.model1.buttonMode=!0,this.model1.hitArea=new PIXI3D.PickingHitArea(this.app.renderer,this.model1,this.camera),this.model1.on("pointerdown",()=>{this.model2.animations.forEach(e=>{e.play(),e.position=.63}),this.model1.scale.set(0),this.model2.scale.set(1),document.getElementById("ui-content").innerHTML=""}),this.model1.meshes.forEach(e=>{e.material.camera=this.camera,e.material.lightingEnvironment=this.lightingEnvironment,e.material.exposure=1.2}),this.model2=this.container.addChild(PIXI3D.Model.from(e["models/engel/engel2.gltf"].gltf)),this.model2.scale.set(0),this.model2.meshes.forEach(e=>{e.material.camera=this.camera,e.material.lightingEnvironment=this.lightingEnvironment,e.material.exposure=1}),this.model2.animations.forEach(e=>{e.speed=1.5,e.on("complete",()=>{this.model1.scale.set(1),this.model2.scale.set(0)})})}hide(){this.model1.meshes.forEach(e=>{e.destroy()}),this.model2.meshes.forEach(e=>{e.destroy()}),this.app.stage.removeChildren(),document.getElementById("ui-content").innerHTML=""}}},function(e,t,s){"use strict";s.r(t),s.d(t,"Overlay",(function(){return i}));class i{constructor(e){this.element=document.getElementById(e),this.element.classList.add("overlay")}show(e){this.element.classList.add("overlay-show"),e&&setTimeout(()=>{e()},.5)}hide(e){this.element.classList.remove("overlay-show"),e&&setTimeout(()=>{e()},.5)}}},function(e,t,s){"use strict";s.r(t),s.d(t,"DemoThumb",(function(){return i}));class i{constructor(e,t,s,i){this.demo=t,this.element=document.getElementById(e),this.element.addEventListener("click",()=>{i(t),document.getElementById("ui-license").innerHTML=s})}select(){this.element.click()}}},function(e,t){e.exports="attribute vec3 a_Position;\nattribute vec3 a_UV1;\nattribute vec3 a_Normal;\n\nvarying vec4 v_Position;\nvarying vec3 v_UV1;\nvarying vec3 v_Normal;\n\nuniform mat4 u_ViewProjection;\nuniform mat4 u_Model;\n\nvoid main() {\n  v_Position = u_Model * vec4(a_Position, 1.0);\n  v_Normal = a_Normal;\n  v_UV1 = a_UV1;\n  gl_Position = u_ViewProjection * u_Model * vec4(a_Position, 1.0);\n}"},function(e,t){e.exports="varying vec3 v_Normal;\nvarying vec3 v_UV1;\nvarying vec4 v_Position;\n\nuniform vec3 u_Color;\nuniform vec3 u_Color2;\nuniform float u_Alpha;\n\nvoid main() {\n  vec3 pos = v_Position.xyz / v_Position.w;\n  if (pos.y < -4.0) {\n    // discard;\n  }\n  vec3 normal = normalize(v_Normal * 0.5 + 0.5);\n  float up = normal.y; //float( > 0.0 || v_Normal.x < 0.0 || v_Normal.z > 0.0 || v_Normal.z < 0.0);\n  float alpha = 1.0;// + (v_Position.y * 0.5);\n  float shade = normal.y + normal.x * 0.1;\n  // vec3 color = u_Color;// - (normal.z * 0.5);\n  // if (pos.y <= -2.0) {\n  //   color = mix(color, vec3(0.0, 0.0, 0.0), (-2.0 - pos.y) * 0.5);\n  //   float a = (-2.0 - pos.y) * 0.5;\n  //   color = vec3(a);\n  // }\n\n  float a = -1.0;\n  float b = -7.0;\n\n  float fade = clamp((a - pos.y) * (a/b), 0.0, 1.0);\n  vec3 color = mix(u_Color * shade, u_Color2, pow(fade, 0.9));\n\n  // vec3 color = u_Color * (v_Normal * 0.5 + 0.5);\n  // vec4 color = vec4((u_Color * (v_Normal * 0.5 + 0.5)) * alpha, alpha);\n  // gl_FragColor = vec4(vec3(v_Position.y + 1.0), 1.0);\n  // gl_FragColor = vec4(u_Color * (v_Normal * 0.5 + 0.5), 1.0);\n  gl_FragColor = vec4(vec3(color * 1.0 * u_Alpha), u_Alpha);\n}"},function(e,t,s){"use strict";s.r(t),s.d(t,"PinkCube",(function(){return k}));var i=s(0);const o="player_move",r="player_move_blocked",a="player_move_fall",n="player_move_jump",l="player_goal",h="block_move",c="block_move_fall",u="gate_open",m="gate_close",d="button_press",p="button_release",_="scene_crash";class g extends PIXI3D.Container3D{constructor(e=0,t=0,s=0,i){super(),this.position.set(e,t,s),this._mesh=this.addChild(PIXI3D.Mesh3D.createCube()),this._mesh.scale.set(.5,.5,.5),this._mesh.material.lightingEnvironment=i,this._mesh.material.metallic=0,this._mesh.material.roughness=.2,this._mesh.material.unlit=!1,this._mesh.material.baseColor=new PIXI3D.Color(.1,.1,.1),this._mesh.position.set(0,0,0)}move(e){gsap.to(this,{x:this.x+e.x,z:this.z+e.z,duration:.2,ease:"power1.out"})}moveFall(e,t){gsap.to(this,{x:this.x+e.x,z:this.z+e.z,duration:.2}),gsap.to(this,{y:t,duration:.3,delay:0,ease:"back.in"})}}class f extends PIXI3D.Material{constructor(){super(),this.color=new PIXI3D.Color,this.color2=new PIXI3D.Color(1,180/255,248/255),this.alpha=1}createShader(){return new PIXI3D.MeshShader(PIXI.Program.from(s(6),s(7)))}updateUniforms(e,t){t.uniforms.u_Model=e.worldTransform.array,t.uniforms.u_ViewProjection=PIXI3D.Camera.main.viewProjection,t.uniforms.u_Color=this.color.rgba,t.uniforms.u_Color2=this.color2.rgba,t.uniforms.u_Alpha=this.alpha}}class v extends PIXI3D.Container3D{constructor(e=0,t=0,s=0){super(),this.position.set(e,t,s);const i=(e%2==0?s%2==1:s%2==0)?1:.95;this._mesh=this.addChild(PIXI3D.Mesh3D.createCube(new f)),this._mesh.scale.set(.5,.5,.5),this._mesh.material.color=new PIXI3D.Color(.2*i,1*i,.4*i),this._mesh.position.set(0,-.9,0)}press(){gsap.to(this._mesh,{y:-1,duration:.2})}release(){gsap.to(this._mesh,{y:-.93,duration:.2})}}class y{constructor(e){PIXI3D.Camera.main.orthographic=!0,PIXI3D.Camera.main.orthographicSize=7,this.drag={x:.5,y:.01,z:.5},this._control=new PIXI3D.CameraOrbitControl(e),this._control.allowControl=!1,this._control.angles.set(25,-20),this._control.distance=100,this._track={x:0,y:0,z:0};const t=(e,t,s)=>e+(t-e)*s;PIXI.Ticker.shared.add(()=>{this._control.target={x:t(this._control.target.x,this._track.x,this.drag.x),y:t(this._control.target.y,this._track.y,this.drag.y),z:t(this._control.target.z,this._track.z,this.drag.z)}})}get zoom(){return PIXI3D.Camera.main.orthographicSize}set zoom(e){PIXI3D.Camera.main.orthographicSize=e}get angles(){return this._control.angles}reset(){PIXI3D.Camera.main.orthographicSize=7,this._control.angles.set(25,-20),this.drag={x:.5,y:.01,z:.5}}track(e){this._track=e}lookAt(e){this._track=e,this._control.target=e}}class I extends PIXI3D.Container3D{constructor(e=0,t=0,s=0){super(),this.position.set(e,t,s);let i=(e%2==0?s%2==1:s%2==0)?1:.95;this._mesh=this.addChild(PIXI3D.Mesh3D.createCube(new f)),this._mesh.scale.set(.5,20,.5),this._mesh.material.color=new PIXI3D.Color(.1*i,.9*i,.3*i),this._mesh.position.set(0,-this._mesh.scale.y-.5,0)}}class w extends PIXI3D.Container3D{constructor(e=0,t=0,s=0,i=0){super(),this.position.set(e,t,s),this._mesh=this.addChild(PIXI3D.Mesh3D.createCube(new f)),this._mesh.scale.set(.5,1,.1),this._mesh.material.color=PIXI3D.Color.fromBytes(200,255,200),90===i&&this._mesh.rotationQuaternion.setEulerAngles(0,90,0)}open(){gsap.to(this._mesh,{y:-1.49,duration:1,ease:"power2.out",delay:.2})}close(){gsap.to(this._mesh,{y:0,duration:1,ease:"power2.out",delay:.2})}}class x extends PIXI3D.Container3D{constructor(e=0,t=0,s=0,i,o){super(),this.position.set(e,t,s),this._model=this.addChild(PIXI3D.Model.from(i["assets/pink-cube/goal.gltf"].gltf)),this._model.scale.set(.63),this._model.position.set(0,-.5,0),this._model.meshes.forEach(e=>{e.material.lightingEnvironment=o,e.material.baseColor=new PIXI3D.Color(0,1,0),e.material.metallic=0,e.material.roughness=.5})}}class P extends PIXI3D.Container3D{constructor(e,t,s){super(),this._camera=e,this._isMoving=!1,this._mesh=this.addChild(PIXI3D.Mesh3D.createCube()),this._mesh.material.lightingEnvironment=s,this._mesh.material.metallic=0,this._mesh.material.roughness=.5,this._mesh.material.baseColor=new PIXI3D.Color(.8,.2,.6),this._mesh.material.exposure=3,this._mesh.scale.set(.5),this._model=this.addChild(PIXI3D.Model.from(t["assets/pink-cube/crash.glb"].gltf)),this._model.scale.set(0),this._model.rotationQuaternion.setEulerAngles(0,180,0),this._model.meshes.forEach(e=>{e.material.lightingEnvironment=s,e.material.metallic=0,e.material.roughness=.5,e.material.baseColor=new PIXI3D.Color(.8,.2,.6),e.material.exposure=3})}get isMoving(){return this._isMoving}get worldPosition(){return{x:this._mesh.worldTransform.position[0],y:this._mesh.worldTransform.position[1],z:this._mesh.worldTransform.position[2]}}reset(){this._model.scale.set(0),this._mesh.visible=!0,this._mesh.rotationQuaternion.set(0,0,0,1),this._mesh.position.set(0,0,0)}start(){this._mesh.y=2,gsap.to(this._mesh,{delay:0,duration:.5,y:0,ease:"bounce.out"})}crash(){const e={angle:0};gsap.to(e,{delay:0,duration:1.7,angle:270,ease:"power2.out",onUpdate:()=>{this._mesh.rotationQuaternion.setEulerAngles(0,0,e.angle)}}),gsap.to(this,{duration:.9,y:this.y+2,ease:"power1.out"}),gsap.to(this,{duration:.4,y:0,ease:"power1.in",delay:1,onComplete:()=>{gsap.to(this._model.animations[0],{duration:.4,speed:.2,ease:"slow(0.7, 0.7)"}),this._model.animations[0].speed=1,this._model.animations[0].play(),this._model.animations[0].position=1.65,this._mesh.visible=!1,this._model.scale.set(.5)}}),gsap.to(this,{delay:.1,duration:1.7,x:this.x-2.6,ease:"power1.out"})}move(e){this._roll(e,90*PIXI.DEG_TO_RAD,.3,!1,!0,!0)}moveBlocked(e){this._roll(e,10*PIXI.DEG_TO_RAD,.12,!0,!1,!1)}moveJump(e,t,s=.3){this._roll(e,90*PIXI.DEG_TO_RAD,s,!1,!0,!0),gsap.to(this,{y:t,duration:s,ease:"back.out"})}moveFall(e,t){this._roll(e,90*PIXI.DEG_TO_RAD,.3,!1,!0,!0),gsap.to(this,{y:t,duration:.3,ease:"back.in"})}goal(e,t,s){this._roll(e,90*PIXI.DEG_TO_RAD,.3,!1,!0,!0),gsap.to(this,{y:t,duration:.3,ease:"back.in",onComplete:()=>{s&&s()}})}_roll(e,t,s,i,o,r){if(this._isMoving)return;this._isMoving=!0;const a={value:0},n=PIXI3D.Mat4.copy(this._mesh.localTransform.array),l=i?1:0;gsap.to(a,{duration:s,value:t,yoyo:i,repeat:l,onUpdate:()=>{let t=PIXI3D.Mat4.create();PIXI3D.Mat4.translate(t,[-e.x,-1,+e.z],t),0!==e.x?PIXI3D.Mat4.rotateZ(t,a.value*e.x,t):PIXI3D.Mat4.rotateX(t,a.value*e.z,t),PIXI3D.Mat4.translate(t,[e.x,1,-e.z],t),PIXI3D.Mat4.multiply(n,t,t),this._mesh.transform.setFromMatrix(new PIXI3D.Matrix4(t)),o&&this._camera.track(this.worldPosition)},onComplete:()=>{r&&(this.x-=e.x,this.z+=e.z),this._mesh.scale.set(.5),this._mesh.rotationQuaternion.set(0,0,0,1),this._mesh.position.set(0),this._mesh.transform.updateLocalTransform(),this._isMoving=!1}})}}class C extends PIXI3D.Container3D{constructor(e,t,s,i){super(),this._resources=e,this._sounds=s,this._lightingEnvironment=i,this._camera=new y(t),this._stage=this.addChild(new PIXI3D.Container3D),this._player=this.addChild(new P(this._camera,this._resources,this._lightingEnvironment)),this._allowControl=!0}loadSection(e,t){this._section=e.createSection(t),this._player.position.set(this._section.player.x,this._section.player.y,this._section.player.z),this._player.reset(),this._player.start(),this._camera.lookAt({x:this._section.player.x,y:0,z:this._section.player.z}),this._camera.reset(),this._allowControl=!0,this._stage.removeChildren(),this._buttons=[],this._gates=[],this._blocks=[],this._goals=[],this._section.buttons.forEach(e=>{this._buttons.push(this._stage.addChild(new v(e.x,e.y,e.z)))}),this._section.gates.forEach(e=>{this._gates.push(this._stage.addChild(new w(e.x,e.y,e.z,e.angle)))}),this._section.floor.forEach(e=>{this._stage.addChild(new I(e.x,e.y,e.z))}),this._section.goals.forEach(e=>{this._goals.push(this._stage.addChild(new x(e.x,e.y,e.z,this._resources,this._lightingEnvironment)))}),this._section.blocks.forEach(e=>{this._blocks.push(this._stage.addChild(new g(e.x,e.y,e.z,this._lightingEnvironment)))})}_pressButton(e,t){let s=this._buttons.find(s=>s.x===e&&s.z===t);s||console.error("No button at "+e+","+t),s.press()}_releaseButton(e,t){let s=this._buttons.find(s=>s.x===e&&s.z===t);s||console.error("No button at "+e+","+t),s.release()}_openGate(e,t){let s=this._gates.find(s=>s.x===e&&s.z===t);s||console.error("No gate at "+e+","+t),s.open()}_closeGate(e,t){let s=this._gates.find(s=>s.x===e&&s.z===t);s||console.error("No gate at "+e+","+t),s.close()}_moveBlock(e,t,s){let i=this._blocks.find(s=>s.x===e&&s.z===t);i||console.error("No block at "+e+","+t),i.move(s)}_moveFallBlock(e,t,s,i){let o=this._blocks.find(s=>s.x===e&&s.z===t);o||console.error("No block at "+e+","+t),o.moveFall(s,i)}_movePlayer(e){if(this._player.isMoving||!this._allowControl)return;this._sounds.volume(.3,this._sounds.play("tap"));let t={x:0,z:0};Math.abs(e[0])>=Math.abs(e[2])?t.x=e[0]>0?1:-1:t.z=e[2]>0?1:-1;let s=this._section.movePlayer(t);this._playAnimations(s)}_crash(){this._allowControl=!1,this.onScene();const e=()=>{this._camera.track(this._player.worldPosition)};PIXI.Ticker.shared.add(e),setTimeout(()=>{gsap.to(this._camera,{duration:7.5,zoom:4,ease:"power1.inOut"})},0),setTimeout(()=>{this._player.moveJump({x:1,z:0},this._player.y+1,.7)},600),setTimeout(()=>{gsap.to(this._camera.angles,{duration:5.5,y:45,ease:"power1.inOut"})},1600),setTimeout(()=>{this._player.moveJump({x:1,z:0},this._player.y+1,1.1)},2500),setTimeout(()=>{gsap.to(this._camera.drag,{duration:1,y:.2}),this._player.crash()},5500),setTimeout(()=>{gsap.to(this._camera.drag,{duration:1,y:.2}),this._player.crash()},5500),setTimeout(()=>{this._sounds.play("sad")},6900),setTimeout(()=>{PIXI.Ticker.shared.remove(e),this.onReset()},15e3)}_playAnimations(e){for(let t of e)switch(t.animation){case o:this._player.move({x:-t.direction.x,z:t.direction.z});break;case r:this._player.moveBlocked({x:-t.direction.x,z:t.direction.z});break;case n:this._player.moveJump({x:-t.direction.x,z:t.direction.z},t.y);break;case a:this._player.moveFall({x:-t.direction.x,z:t.direction.z},t.y);break;case l:this._player.goal({x:-t.direction.x,z:t.direction.z},t.y,()=>{this.onGoal&&(this.onGoal(),this._sounds.volume(.3,this._sounds.play("win")))});break;case d:this._pressButton(t.position.x,t.position.z);break;case p:this._releaseButton(t.position.x,t.position.z);break;case u:this._openGate(t.position.x,t.position.z);break;case m:this._closeGate(t.position.x,t.position.z);break;case h:this._moveBlock(t.position.x,t.position.z,t.direction);break;case c:this._moveFallBlock(t.position.x,t.position.z,t.direction,t.y);break;case _:this._crash()}}movePlayerLeft(){this._movePlayer(PIXI3D.Camera.main.worldTransform.left)}movePlayerFoward(){this._movePlayer(PIXI3D.Camera.main.worldTransform.forward)}movePlayerBackward(){this._movePlayer(PIXI3D.Camera.main.worldTransform.backward)}movePlayerRight(){this._movePlayer(PIXI3D.Camera.main.worldTransform.right)}}class b{constructor(){this._ui=document.createElement("div"),this._ui.className="ui",document.body.appendChild(this._ui);let e=document.createElement("div");e.onclick=()=>{this.onUp()},e.className="button",this._ui.appendChild(e);let t=document.createElement("hr");this._ui.appendChild(t);let s=document.createElement("div");s.onclick=()=>{this.onLeft()},s.className="button",this._ui.appendChild(s);let i=document.createElement("div");i.onclick=()=>{this.onDown()},i.className="button",this._ui.appendChild(i);let o=document.createElement("div");o.onclick=()=>{this.onRight()},o.className="button",this._ui.appendChild(o),this._reset=document.createElement("div"),this._reset.onclick=()=>{this.onReset()},this._reset.className="reload",document.body.appendChild(this._reset)}remove(){document.body.removeChild(this._ui),document.body.removeChild(this._reset)}hide(){this._ui.className="ui",this._reset.className="reload"}show(){this._ui.className="ui show-ui",this._reset.className="reload show"}}class z{constructor(e,t){this._map=e,this._floor=t.floor.map(e=>({...e})),this._buttons=t.buttons.map(e=>({...e})),this._gates=t.gates.map(e=>({...e})),this._blocks=t.blocks.map(e=>({...e})),this._goals=t.goals.map(e=>({...e})),this._scenes=t.scenes.map(e=>({...e})),this._starts=t.starts.map(e=>({...e})),this._player=this._starts[0]}get player(){return{x:this._player.x,y:this._player.y,z:this._player.z}}get floor(){return this._floor.map(e=>({x:e.x,y:e.y,z:e.z}))}get buttons(){return this._buttons.map(e=>({x:e.x,y:e.y,z:e.z}))}get gates(){return this._gates.map(e=>({x:e.x,y:e.y,z:e.z,angle:e.angle}))}get blocks(){return this._blocks.map(e=>({x:e.x,y:e.y,z:e.z}))}get goals(){return this._goals.map(e=>({x:e.x,y:e.y,z:e.z}))}movePlayer(e){const t=[...this._moveBlock(this._player.x+e.x,this._player.y,this._player.z+e.z,e)];let s=this._getHeight(this._player.x+e.x,this._player.z+e.z);return s===this._player.y&&(this._player.x+=e.x,this._player.z+=e.z,t.push({animation:o,direction:e}),t.push(...this._releaseButton(this._player.x-e.x,this._player.z-e.z)),t.push(...this._pressButton(this._player.x,this._player.z))),s===this._player.y+1&&(this._player.x+=e.x,this._player.y=s,this._player.z+=e.z,t.push({animation:n,direction:e,y:s}),t.push(...this._scene(this._player.x,this._player.z))),s<this._player.y&&(this._player.x+=e.x,this._player.y=s,this._player.z+=e.z,this._goals.some(e=>e.x===this._player.x&&e.z===this._player.z)&&t.push({animation:l,direction:e,y:s}),t.push({animation:a,direction:e,y:s})),(s>this._player.y+1||void 0===s)&&t.push({animation:r,direction:e}),t}_moveBlock(e,t,s,i){const o=this._blocks.find(i=>i.x===e&&(void 0===t||i.y===t)&&i.z===s);if(!o)return[];const r=[];let a=this._getHeight(o.x+i.x,o.z+i.z);return a===o.y&&(o.x+=i.x,o.z+=i.z,r.push({animation:h,position:{x:e,z:s},direction:{x:i.x,z:i.z}})),a<t&&(o.x+=i.x,o.y=a,o.z+=i.z,r.push({animation:c,position:{x:e,z:s},y:a,direction:{x:i.x,z:i.z}})),r.push(...this._pressButton(o.x,o.z)),r.push(...this._releaseButton(o.x-i.x,o.z-i.z)),r}_openGate(e,t){const s=[];let i=this._gates.find(s=>s.x===e&&s.z===t);return i||console.error("No gate at "+e+","+t),i.open||(i.open=!0,s.push({animation:u,position:{x:e,z:t}})),s}_closeGate(e,t){const s=[];let i=this._gates.find(s=>s.x===e&&s.z===t);return i||console.error("No gate at "+e+","+t),i.open&&(i.open=!1,s.push({animation:m,position:{x:e,z:t}})),s}_pressButton(e,t){let s=[];for(let i of this._buttons.filter(s=>s.x===e&&s.z===t))i.pressed||(i.pressed=!0,s.push({animation:d,position:{x:e,z:t}}),i.link&&this._gates.filter(e=>e.link===i.link).forEach(e=>{s.push(...this._openGate(e.x,e.z))}));return s}_releaseButton(e,t){let s=[];for(let i of this._buttons.filter(s=>s.x===e&&s.z===t))i.pressed&&(i.pressed=!1,s.push({animation:p,position:{x:e,z:t}}),i.link&&this._gates.filter(e=>e.link===i.link&&e.auto).forEach(e=>{s.push(...this._closeGate(e.x,e.z))}));return s}_scene(e,t){return this._scenes.filter(s=>s.x===e&&s.z===t).map(e=>({animation:_,scene:e.scene}))}_getHeight(e,t){e=Math.ceil(e),t=Math.ceil(t);for(let s of this._gates)if(s.x===e&&s.z===t)return s.open?s.y:100;for(let s of this._goals)if(s.x===e&&s.z===t)return-1;const s=this._blocks.find(s=>s.x===e&&s.z===t);return s?s.y+1:this._map.getHeight(e,t)}}class D{constructor(e,t){this._texture=t,this._pixels=e.plugins.extract.pixels(PIXI.Sprite.from(t)),this._floor=[],this._player={x:0,y:0,z:0},this._buttons=[],this._gates=[],this._blocks=[],this._goals=[],this._starts=[],this._scenes=[],this._height=[];for(let e=0;e<t.width;e++){let e=[];for(let s=0;s<t.height;s++)e.push(void 0);this._height.push(e)}for(let e=0;e<this._pixels.length;e+=4){let s=this._pixels[e+0],i=this._pixels[e+1],o=this._pixels[e+2];if(0===this._pixels[e+3])continue;let r=e/4%t.width,a=(e/4-r)/t.width,n=D.getTileData(s,i,o);n&&("floor"===n.type&&this._floor.push({x:r,y:n.y,z:a}),"scene_crash"===n.type&&(this._floor.push({x:r,y:n.y,z:a}),this._scenes.push({x:r,y:n.y,z:a,scene:"crash"})),"start"===n.type&&(this._starts.push({x:r,y:n.y,z:a,level:o}),this._floor.push({x:r,y:n.y,z:a})),"button"===n.type&&(this._floor.push({x:r,y:n.y,z:a}),this._buttons.push({x:r,y:n.y,z:a,link:o,pressed:!1})),"gate"!==n.type&&"gate_90"!==n.type||(this._floor.push({x:r,y:n.y,z:a}),this._gates.push({x:r,y:n.y,z:a,open:!1,link:o,angle:n.angle})),"auto_gate"!==n.type&&"auto_gate_90"!==n.type||(this._floor.push({x:r,y:n.y,z:a}),this._gates.push({x:r,y:n.y,z:a,open:!1,auto:!0,link:o,angle:n.angle})),"block"===n.type&&(this._floor.push({x:r,y:n.y,z:a}),this._blocks.push({x:r,y:n.y,z:a})),"goal"===n.type&&this._goals.push({x:r,y:n.y,z:a}),this._height[r][a]=n.y)}this._starts.sort((e,t)=>e.level-t.level)}get levels(){return this._starts.length}createSection(e){let t=this._starts[e];if(!t)return void console.error(`Can load level ${e}, doesn't exist`);let s=[],i=(e,t)=>{s.some(s=>s.x===e&&s.z===t)||void 0!==this._height[e][t]&&(s.push({x:e,z:t}),i(e-1,t-0),i(e+1,t-0),i(e-0,t-1),i(e-0,t+1))};return i(t.x,t.z),new z(this,{floor:this._floor.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z)),buttons:this._buttons.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z)),gates:this._gates.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z)),blocks:this._blocks.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z)),goals:this._goals.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z)),starts:this._starts.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z)),scenes:this._scenes.filter(e=>s.some(t=>t.x===e.x&&t.z===e.z))})}getHeight(e,t){return this._height[e][t]}static getTileData(e,t,s){return 255===e?{type:"floor",y:t}:230===e?{type:"scene_crash",y:t}:200===e?{type:"start",y:t}:150===e?{type:"button",y:t,connection:s}:110===e?{type:"gate_90",y:t,connection:s,angle:90}:100===e?{type:"gate",y:t,connection:s,angle:0}:80===e?{type:"auto_gate_90",y:t,connection:s,angle:90}:70===e?{type:"auto_gate",y:t,connection:s,angle:0}:50===e?{type:"block",y:t}:0===e?{type:"goal",y:t}:void 0}}class k extends i.a{constructor(e){super(e),this.resources=["assets/pink-cube/crash.glb","assets/pink-cube/map.png","assets/pink-cube/goal.gltf"],this.levelIndex=0,this.onKeyDown=this.onKeyDown.bind(this)}show(e){this.app.renderer.backgroundColor=16758008,this.lightingEnvironment=new PIXI3D.LightingEnvironment(this.app.renderer,new PIXI3D.ImageBasedLighting(PIXI3D.Cubemap.fromColors(PIXI3D.Color.fromBytes(140,140,140),PIXI3D.Color.fromBytes(140,140,140),PIXI3D.Color.fromBytes(230,230,230),PIXI3D.Color.fromBytes(120,120,120),PIXI3D.Color.fromBytes(160,160,160),PIXI3D.Color.fromBytes(160,160,160)),PIXI3D.Cubemap.fromColors(PIXI3D.Color.fromBytes(255,255,255)))),this.sounds=new Howl({autoplay:!1,src:["assets/pink-cube/sounds.ogg","assets/pink-cube/sounds.m4a","assets/pink-cube/sounds.mp3","assets/pink-cube/sounds.ac3"],sprite:{sad:[0,9366.666666666668],tap:[11e3,291.65532879818556],win:[13e3,1025.1700680272115]}});const t=new D(this.app.renderer,e["assets/pink-cube/map.png"].texture);this.ui=new b,this.ui.onUp=()=>this.level.movePlayerFoward(),this.ui.onDown=()=>this.level.movePlayerBackward(),this.ui.onRight=()=>this.level.movePlayerRight(),this.ui.onLeft=()=>this.level.movePlayerLeft(),this.ui.onReset=()=>this.level.loadSection(t,this.levelIndex),this.ui.show(),document.addEventListener("keydown",this.onKeyDown),this.level=this.app.stage.addChild(new C(e,this.app.view,this.sounds,this.lightingEnvironment)),this.level.loadSection(t,this.levelIndex),this.level.onGoal=()=>{gsap.to(this.flash,{duration:.3,alpha:1,ease:"power3.out",onComplete:()=>{this.levelIndex=(this.levelIndex+1)%t.levels,this.level.loadSection(t,this.levelIndex),gsap.to(this.flash,{duration:.3,alpha:0,ease:"power3.out",delay:.05})}})},this.level.onReset=()=>{this.ui.show(),gsap.to(this.flash,{duration:.3,alpha:1,ease:"power3.out",onComplete:()=>{this.cinema.value=0,this.level.loadSection(t,this.levelIndex),gsap.to(this.flash,{duration:.3,alpha:0,ease:"power3.out",delay:.05})}})},this.level.onScene=()=>{setTimeout(()=>{this.ui.hide()},1e3),gsap.to(this.cinema,{duration:2,value:1,ease:"sine.inOut"})},this.cinema={value:0},this.cinema1=this.app.stage.addChild(new PIXI.Graphics),this.cinema1.beginFill(0),this.cinema1.drawRect(0,0,32,32),this.cinema1.endFill(),this.cinema2=this.app.stage.addChild(new PIXI.Graphics),this.cinema2.beginFill(0),this.cinema2.drawRect(0,0,32,32),this.cinema2.endFill(),this.flash=this.app.stage.addChild(new PIXI.Sprite(PIXI.Texture.WHITE)),this.flash.alpha=0,this.app.ticker.add(()=>{this.flash.width=this.app.renderer.width,this.flash.height=this.app.renderer.height,this.cinema2.width=this.app.renderer.width,this.cinema2.height=.15*this.app.renderer.height*this.cinema.value,this.cinema2.y=this.app.renderer.height-.15*this.app.renderer.height*this.cinema.value,this.cinema1.width=this.app.renderer.width,this.cinema1.height=.15*this.app.renderer.height*this.cinema.value})}onKeyDown(e){switch(e.key){case"a":case"ArrowLeft":this.level.movePlayerLeft();break;case"w":case"ArrowUp":this.level.movePlayerFoward();break;case"s":case"ArrowDown":this.level.movePlayerBackward();break;case"d":case"ArrowRight":this.level.movePlayerRight()}}hide(){PIXI3D.Camera.main.orthographic=!1,document.removeEventListener("keydown",this.onKeyDown),this.ui.remove(),this.app.stage.removeChildren()}}},function(e,t,s){"use strict";s.r(t),s.d(t,"WalrusCave",(function(){return g}));var i=s(0);class o extends PIXI3D.Container3D{constructor(e,t,s){super(),this.model=this.addChild(PIXI3D.Model.from(e)),this.model.scale.set(1.9),this.model.meshes.forEach(e=>{e.enableRenderPass("color"),e.material.exposure=s}),this.tween=gsap.to(this.model,{duration:1,y:t,yoyo:!0,repeat:-1,ease:"sine.inOut"})}destroy(e){super.destroy(e),this.tween.kill()}}class r extends PIXI3D.Container3D{constructor(e,t,s,i,o=1){super(),this.speed=i,this.rotation=s,this.ticker=new PIXI.Ticker,this.ticker.add(()=>{this.rotationQuaternion.setEulerAngles(0,this.rotation-=this.speed,0)}),this.ticker.start();let r=this.addChild(PIXI3D.Model.from(e));r.z=t,r.y=-.7,r.scale.set(o),r.meshes.forEach(e=>{e.material=new a,e.enableRenderPass("color")})}destroy(e){super.destroy(e),this.ticker.stop()}}class a extends PIXI3D.Material{constructor(e=.2,t=1.3,s=2.5){super(),this._time=100*Math.random(),PIXI.Ticker.shared.add(()=>{this._time+=PIXI.Ticker.shared.elapsedMS/1e3}),this.size=e,this.strength=t,this.speed=s,this.color=new PIXI3D.Color}updateUniforms(e,t){t.uniforms.u_ViewProjection=PIXI3D.Camera.main.viewProjection,t.uniforms.u_Model=e.worldTransform.array,t.uniforms.u_Speed=this.speed,t.uniforms.u_Size=this.size,t.uniforms.u_Strength=this.strength,t.uniforms.u_Time=this._time,t.uniforms.u_Color=this.color.rgb}createShader(){return new PIXI3D.MeshShader(PIXI.Program.from(n,l))}}const n="\nattribute vec3 a_Position;\n\nvarying vec3 v_Position;\n\nuniform mat4 u_ViewProjection;\nuniform mat4 u_Model;\nuniform float u_Time;\nuniform float u_Speed;\nuniform float u_Strength;\nuniform float u_Size;\n\nvoid main() {\n  float offset = sin(a_Position.x * u_Size + u_Time * u_Speed);\n  vec3 position = a_Position + vec3(0, 0, offset * u_Strength);\n  gl_Position = u_ViewProjection * u_Model * vec4(position, 1.0);\n  v_Position = a_Position.xyz;\n}\n",l="\nvarying vec3 v_Position;\n\nuniform vec3 u_Color;\n\nvoid main() {\n  gl_FragColor = vec4(u_Color, 1.0);\n}\n";class h extends PIXI3D.Container3D{constructor(e){super(),this.model=this.addChild(PIXI3D.Model.from(e)),this.model.y=1.6,this.model.scale.set(.03),this.ticker=new PIXI.Ticker,this.ticker.start();let t=0;this.ticker.add(()=>{this.model.rotationQuaternion.setEulerAngles(0,t+=.01,0)}),this.model.meshes.forEach(e=>{e.material=new c})}destroy(e){super.destroy(e),this.ticker.stop()}}class c extends PIXI3D.Material{constructor(){super(),this._texture=PIXI.Texture.from("assets/walrus-cave/sky.jpg"),this.horizonSize=50,this.horizonColor=PIXI3D.Color.fromBytes(255,255,255),this.state.culling=!0,this.state.clockwiseFrontFace=!1}updateUniforms(e,t){t.uniforms.u_ViewProjection=PIXI3D.Camera.main.viewProjection,t.uniforms.u_Model=e.worldTransform.array,t.uniforms.u_Texture=this._texture,t.uniforms.u_HorizonColor=this.horizonColor.rgb,t.uniforms.u_HorizonSize=this.horizonSize}createShader(){return new PIXI3D.MeshShader(PIXI.Program.from(u,m))}}const u="\nattribute vec3 a_Position;\nattribute vec2 a_UV1;\n\nvarying vec3 v_Position;\nvarying vec2 v_UV1;\n\nuniform mat4 u_ViewProjection;\nuniform mat4 u_Model;\n\nvoid main() {\n  gl_Position = u_ViewProjection * u_Model * vec4(a_Position, 1.0);\n  v_UV1 = a_UV1;\n}\n",m="\nvarying vec2 v_UV1;\n\nuniform sampler2D u_Texture;\nuniform vec3 u_HorizonColor;\nuniform float u_HorizonSize;\n\nvoid main() {\n  vec3 sampledColor = texture2D(u_Texture, v_UV1).rgb;\n  float horizonMask = smoothstep(0.2, 0.5, 1.0 - v_UV1.y * u_HorizonSize);\n  vec3 finalColor = mix(sampledColor * 1.6, u_HorizonColor, horizonMask);\n  gl_FragColor = vec4(finalColor, 1.0);\n}\n";class d extends PIXI3D.Container3D{constructor(e,t,s,i){super();let o=PIXI.Texture.from("assets/walrus-cave/water-height.png");o.baseTexture.wrapMode=PIXI.WRAP_MODES.REPEAT;let r=PIXI.Texture.from("assets/walrus-cave/water-normal.png");r.baseTexture.wrapMode=PIXI.WRAP_MODES.REPEAT;let a=0;PIXI.Ticker.shared.add(()=>{a+=PIXI.Ticker.shared.elapsedMS/1e3});let n=PIXI3D.Color.fromBytes(30,30,30),l=PIXI3D.Color.fromBytes(0,123,180),h=PIXI3D.Material.from(p,_,(e,h)=>{h.uniforms.u_ViewProjection=PIXI3D.Camera.main.viewProjection,h.uniforms.u_Model=e.worldTransform.array,h.uniforms.u_DepthTexture=i,h.uniforms.u_ColorTexture=s.renderTexture,h.uniforms.u_Resolution=[t.width,t.height],h.uniforms.u_ShallowWaterColor=n.rgb,h.uniforms.u_DeepWaterColor=l.rgb,h.uniforms.u_Time=a,h.uniforms.u_WaterHeightTexture=o,h.uniforms.u_WaterNormalTexture=r,h.uniforms.u_RefractionStrength=.05,h.uniforms.u_Depth=3,h.uniforms.u_NormalStrength=1,h.uniforms.u_LightDirection=PIXI3D.LightingEnvironment.main.lights[0].worldTransform.forward,h.uniforms.u_CameraPosition=PIXI3D.Camera.main.worldTransform.position,h.uniforms.u_CameraNear=PIXI3D.Camera.main.near,h.uniforms.u_CameraFar=PIXI3D.Camera.main.far,h.uniforms.u_WaveStrength=.5});this.model=this.addChild(PIXI3D.Model.from(e)),this.model.scale.set(.9),this.model.meshes[0].material=h}}const p="\n#version 100\nprecision highp float;\n\nattribute vec3 a_Position;\nattribute vec2 a_UV1;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent;\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec2 v_UV1;\nvarying mat3 v_TBN;\n\nuniform mat4 u_ViewProjection;\nuniform mat4 u_Model;\nuniform sampler2D u_WaterHeightTexture;\nuniform float u_Time;\nuniform float u_WaveStrength;\n\nfloat getWaterSurfaceHeight(vec2 offset, float tiling) {\n  vec2 waterHeightUV = (a_UV1 * tiling) + offset;\n  float sampledHeight = texture2D(u_WaterHeightTexture, waterHeightUV).r * 2.0 - 1.0;\n  return sampledHeight;\n}\n\nvoid main() {\n  vec2 waterScroll1 = normalize(vec2(0, 1)) * u_Time * 0.3;\n  vec2 waterScroll2 = normalize(vec2(0, -1)) * u_Time * 0.3;\n\n  float waterSurfaceHeight1 = getWaterSurfaceHeight(waterScroll1, 7.0);\n  float waterSurfaceHeight2 = getWaterSurfaceHeight(waterScroll2, 5.0);\n  float finalWaterSurfaceHeight = (waterSurfaceHeight1 + waterSurfaceHeight2) * u_WaveStrength;\n\n  vec3 position = a_Position + vec3(0, finalWaterSurfaceHeight, 0);\n\n  v_UV1 = a_UV1;\n  v_WorldPosition = (u_Model * vec4(position, 1.0)).xyz;\n  v_Normal = a_Normal;\n\n  vec3 bitangent = cross(a_Normal, a_Tangent.xyz);\n\n  vec3 T = normalize(vec3(u_Model * a_Tangent));\n  vec3 B = normalize(vec3(u_Model * vec4(bitangent, 0.0)));\n  vec3 N = normalize(vec3(u_Model * vec4(a_Normal, 0.0)));\n\n  v_TBN = mat3(T, B, N);\n\n  gl_Position = u_ViewProjection * u_Model * vec4(position, 1.0);\n}\n",_="\n#version 100\nprecision highp float;\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec2 v_UV1;\nvarying mat3 v_TBN;\n\nuniform sampler2D u_DepthTexture;\nuniform sampler2D u_ColorTexture;\nuniform float u_Time;\nuniform vec2 u_Resolution;\nuniform vec3 u_ShallowWaterColor;\nuniform vec3 u_DeepWaterColor;\nuniform sampler2D u_WaterColorTexture;\nuniform sampler2D u_WaterNormalTexture;\n\nuniform float u_RefractionStrength;\nuniform float u_Depth;\nuniform float u_NormalStrength;\nuniform vec3 u_LightDirection;\nuniform float u_CameraNear;\nuniform float u_CameraFar;\nuniform vec3 u_CameraPosition;\n\nfloat linearizeDepth(float d, float zNear, float zFar) {\n  float z_n = 2.0 * d - 1.0;\n  return 2.0 * zNear * zFar / (zFar + zNear - z_n * (zFar - zNear));\n}\n\nvec3 getRefractionColor(vec2 offset) {\n  float refractionStrength = u_RefractionStrength;\n\n  vec2 sampledWaterNormal = (texture2D(u_WaterNormalTexture, v_UV1 + offset).rg * 2.0 - 1.0) * refractionStrength;\n  vec2 screenPosition = gl_FragCoord.xy / u_Resolution;\n  vec2 screenPositionRefraction = screenPosition + sampledWaterNormal;\n\n  vec3 sampledRefraction = texture2D(u_ColorTexture, screenPositionRefraction).rgb;\n  return sampledRefraction;\n}\n\nfloat getWaterDepth() {\n  float maxDepthDistance = u_Depth;\n\n  vec2 screenPosition = gl_FragCoord.xy / u_Resolution;\n\n  vec4 sampledDepth = texture2D(u_DepthTexture, screenPosition);\n  float currentDepth = linearizeDepth(gl_FragCoord.z, u_CameraNear, u_CameraFar);\n  float terrainDepth = linearizeDepth(sampledDepth.r, u_CameraNear, u_CameraFar);\n  \n  float depthDifference = abs(terrainDepth - currentDepth);\n  float distanceToTerrain = clamp(depthDifference / maxDepthDistance, 0.0, 1.0);\n\n  return distanceToTerrain;\n}\n\nvec3 getDiffuseLight(vec3 normal) {\n  vec3 L = normalize(-u_LightDirection);\n  vec3 N = normalize(normal);\n  float diffuseLight = clamp(dot(N, L), 0.0, 1.0);\n  float diffuseLightStrength = 0.3;\n  return vec3(diffuseLight * diffuseLightStrength);\n}\n\nvec3 getSpecularLight(vec3 normal) {\n  vec3 L = normalize(-u_LightDirection);\n  vec3 V = normalize(u_CameraPosition - v_WorldPosition);\n  vec3 R = reflect(L, normal);\n  float specularLight = clamp(dot(V, R), 0.0, 1.0);\n  float gloss = 0.85;\n  float specularExponent = pow(specularLight, gloss);\n  return vec3(specularExponent);\n}\n\nvec3 getWaterSurfaceNormal(vec2 offset, float tiling) {\n  vec2 waterNormalUV = v_UV1 * tiling + offset;\n  vec3 sampledNormal = texture2D(u_WaterNormalTexture, waterNormalUV).rgb * 2.0 - 1.0;\n  vec3 waterSurfaceNormal = normalize(v_TBN * sampledNormal) * u_NormalStrength; \n  return waterSurfaceNormal;\n}\n\nvec3 getWaterDepthColor(float waterDepth) {\n return mix(u_ShallowWaterColor, u_DeepWaterColor, waterDepth);\n}\n\nvoid main() {\n  vec3 normal = normalize(v_Normal);\n  if (abs(normal.x) > 0.0 || normal.y < -0.1) {\n    discard;\n  }\n  vec2 waterScroll1 = normalize(vec2(0, 1)) * u_Time * 0.3;\n  vec2 waterScroll2 = normalize(vec2(0, -1)) * u_Time * 0.3;\n  vec3 waterSurfaceNormal1 = getWaterSurfaceNormal(waterScroll1, 7.0);\n  vec3 waterSurfaceNormal2 = getWaterSurfaceNormal(waterScroll2, 5.0);\n  vec3 waterSurfaceNormal = waterSurfaceNormal1 + waterSurfaceNormal2;\n\n  float waterDepth = getWaterDepth();\n  vec3 waterDepthColor = getWaterDepthColor(waterDepth);\n  vec3 waterRefractionColor = getRefractionColor(waterSurfaceNormal.rg);\n  float waterRefractionMask = 1.0 - waterDepth;\n  vec3 waterRefraction = mix(vec3(0), waterRefractionColor, waterRefractionMask);\n  \n  vec3 diffuseLight = getDiffuseLight(waterSurfaceNormal);\n  vec3 specularLight = getSpecularLight(waterSurfaceNormal);\n  vec3 finalLightColor = diffuseLight + specularLight;\n  vec3 finalWaterColor = waterDepthColor + waterRefraction + finalLightColor;\n\n  gl_FragColor = vec4(finalWaterColor, 1);\n}\n";class g extends i.a{constructor(e){super(e),this.resources=["assets/walrus-cave/cave.glb","assets/walrus-cave/shark.glb","assets/walrus-cave/sky.glb","assets/walrus-cave/sky.jpg","environments/photo_studio/diffuse.cubemap","environments/photo_studio/specular.cubemap","assets/walrus-cave/surface.glb","assets/walrus-cave/water-normal.png","assets/walrus-cave/water-height.png","assets/walrus-cave/crate.glb"];let t=new Hammer(document.getElementById("demo-canvas"),{});t.on("pan",e=>{this.control&&(this.control.angles.y+=2*e.velocityX),this.tween&&this.tween.kill()}),t.on("panend",e=>{this.control&&(this.tween=gsap.to(this.control.angles,{duration:1,y:-105,ease:"power2.out"}))})}show(e){PIXI3D.Camera.main.far=100,this.control=new PIXI3D.CameraOrbitControl(this.app.view),this.control.angles.x=15,this.control.angles.y=-105,this.control.target={x:0,y:0,z:1.8},this.control.distance=20,this.control.allowControl=!1,this.ticker=new PIXI.Ticker,this.ticker.start();let t=this.app.renderer.plugins.pipeline;this.colorRenderTexture=PIXI.RenderTexture.create({width:this.app.renderer.width,height:this.app.renderer.height}),this.colorRenderTexture.rotate=8,this.colorRenderTexture.framebuffer.addDepthTexture(),this.ticker.add(()=>{this.colorRenderTexture.resize(this.app.renderer.width,this.app.renderer.height);let e=this.app.renderer.width/this.app.renderer.height;PIXI3D.Camera.main.fieldOfView=e>.8?60:90}),this.colorPass=new PIXI3D.MaterialRenderPass(this.app.renderer,"color"),this.colorPass.renderTexture=this.colorRenderTexture;let s=new PIXI.Texture(this.colorRenderTexture.framebuffer.depthTexture);t.renderPasses.unshift(this.colorPass);let i=this.app.stage.addChild(new PIXI3D.Container3D);i.rotationQuaternion.setEulerAngles(0,270,0);let a=i.addChild(Object.assign(new PIXI3D.Light,{intensity:1,type:"directional",enabled:!1}));a.rotationQuaternion.setEulerAngles(25,0,0),a.position.set(0,10,10),PIXI3D.LightingEnvironment.main.lights.push(a);let n=new PIXI3D.ImageBasedLighting(e["environments/photo_studio/diffuse.cubemap"].cubemap,e["environments/photo_studio/specular.cubemap"].cubemap);PIXI3D.LightingEnvironment.main.imageBasedLighting=n,this.cave=this.app.stage.addChild(PIXI3D.Model.from(e["assets/walrus-cave/cave.glb"].gltf)),this.cave.meshes.forEach(e=>{e.enableRenderPass("color")}),this.sharks=[this.app.stage.addChild(new r(e["assets/walrus-cave/shark.glb"].gltf,-13,-40,.25,.4)),this.app.stage.addChild(new r(e["assets/walrus-cave/shark.glb"].gltf,-15,-70,.25,.3)),this.app.stage.addChild(new r(e["assets/walrus-cave/shark.glb"].gltf,-14,170,.25,.45))];let l=this.app.stage.addChild(new o(e["assets/walrus-cave/crate.glb"].gltf,.3,3));l.y=.8,l.x=7,l.rotationQuaternion.setEulerAngles(-10,-10,0);let c=this.app.stage.addChild(new o(e["assets/walrus-cave/crate.glb"].gltf,-.3,4));c.y=1,c.x=9,c.z=2,c.rotationQuaternion.setEulerAngles(8,25,0),this.crates=[l,c],this.sky=this.app.stage.addChild(new h(e["assets/walrus-cave/sky.glb"].gltf)),this.water=this.app.stage.addChild(new d(e["assets/walrus-cave/surface.glb"].gltf,this.app.renderer,this.colorPass,s)),this.water.y=1.4}hide(){this.colorRenderTexture.destroy(),this.cave.destroy(!0),this.sky.destroy(!0),this.sharks.forEach(e=>{e.destroy(!0)}),this.crates.forEach(e=>{e.destroy(!0)}),this.water.destroy(!0),this.ticker.stop(),PIXI3D.Camera.main.far=1e3,PIXI3D.Camera.main.fieldOfView=60;let e=this.app.renderer.plugins.pipeline;e.renderPasses.splice(e.renderPasses.indexOf(this.colorPass),1),console.log(e.renderPasses),this.colorPass.renderTexture=void 0,this.app.stage.removeChildren()}}}]);